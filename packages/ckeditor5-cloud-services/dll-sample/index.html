<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DLL sample - Cloud Services</title>
</head>
<body>

<div id="editor">
	<h2>Token URL callback example</h2>
</div>

<style>
	pre {
		white-space: pre-wrap;
		white-space: -moz-pre-wrap;
		white-space: -o-pre-wrap;
		word-wrap: break-word;
	}
</style>

<div id="request"></div>

<pre id="output"></pre>

<script src="https://unpkg.com/@ckeditor/ckeditor5-inspector/build/inspector.js"></script>

<!-- This adds the CKEditor5_DLL in the global scope, so it is possible to reference its contents -->
<script src="./../../../node_modules/ckeditor5/build/ckeditor5-dll.js"></script>

<!-- Those are stripped-down editors with Essentials plugins loaded from a DLL, exposed on CKEditor global -->
<script src="./../../../node_modules/@ckeditor/ckeditor5-dll-classic/build/dll-classic.js"></script>

<!-- Editor features as DLL consumer builds exposed as CKEditor5[featureName] -->
<script src="./../../../node_modules/@ckeditor/ckeditor5-adapter-ckfinder/build/adapter-ckfinder.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-alignment/build/alignment.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-autoformat/build/autoformat.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-autosave/build/autosave.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-basic-styles/build/basic-styles.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-block-quote/build/block-quote.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-ckfinder/build/ckfinder.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-cloud-services/build/cloud-services.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-code-block/build/code-block.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-easy-image/build/easy-image.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-editor-balloon/build/editor-balloon.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-editor-classic/build/editor-classic.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-editor-decoupled/build/editor-decoupled.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-editor-inline/build/editor-inline.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-essentials/build/essentials.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-font/build/font.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-heading/build/heading.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-highlight/build/highlight.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-horizontal-line/build/horizontal-line.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-html-embed/build/html-embed.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-image/build/image.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-indent/build/indent.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-link/build/link.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-list/build/list.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-markdown-gfm/build/markdown-gfm.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-media-embed/build/media-embed.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-mention/build/mention.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-page-break/build/page-break.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-paste-from-office/build/paste-from-office.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-remove-format/build/remove-format.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-restricted-editing/build/restricted-editing.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-special-characters/build/special-characters.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-table/build/table.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-watchdog/build/watchdog.js"></script>
<script src="./../../../node_modules/@ckeditor/ckeditor5-word-count/build/word-count.js"></script>

<script>
	const TOKEN_URL = 'https://33333.cke-cs.com/token/dev/ijrDsqFix838Gh3wGO3F77FSW94BwcLXprJ4APSp3XQ26xsUHTi0jcb1hoBt';
	const UPLOAD_URL = 'https://33333.cke-cs.com/easyimage/upload/';

	const {
		ClassicEditor,
		blockQuote,
		codeBlock,
		basicStyles,
		heading,
		htmlEmbed,
		image,
		indent,
		link,
		list,
		mediaEmbed,
		table,
		cloudServices
	} = CKEditor5;

	const config = {
		extraPlugins: [
			heading.Heading,
			cloudServices.CloudServices
		].filter( plugin => !!plugin ),
		toolbar: [ 'heading', '|', 'undo', 'redo' ],
		cloudServices: {
			tokenUrl: getToken,
			uploadUrl: UPLOAD_URL
		}
	};

	// ClassicEditor is exposed by the ckeditor5-dll-classic:
	ClassicEditor.create( document.querySelector( '#editor' ), config )
		.then( editor => {
			window.editor = editor;

			CKEditorInspector.attach( editor );
		} );

	const output = document.getElementById( 'output' );
	const requestOutput = document.getElementById( 'request' );

	function handleRequest( xhr, resolve, reject ) {
		requestOutput.innerHTML = `
		<div>XHR request: <pre class='xhr-data'></pre></div>
		<button class="resolve">Resolve with the xhr response</button>
		<button class="reject">Reject with an error</button>
	`;

		const xhrSpan = requestOutput.querySelector( '.xhr-data' );
		const xhrData = {
			status: xhr.status,
			response: xhr.response
		};
		xhrSpan.innerText = JSON.stringify( xhrData, null, 2 );

		const resolveButton = requestOutput.querySelector( '.resolve' );
		resolveButton.addEventListener( 'click', () => resolve( xhr.response ) );

		const rejectButton = requestOutput.querySelector( '.reject' );
		rejectButton.addEventListener( 'click', () => reject( new Error( 'Cannot download new token!' ) ) );
	}

	function getToken() {
		return new Promise( ( resolve, reject ) => {
			const xhr = new XMLHttpRequest();

			xhr.open( 'GET', TOKEN_URL );

			xhr.addEventListener( 'load', () => {
				handleRequest( xhr, resolve, reject );
			} );

			xhr.addEventListener( 'error', () => reject( new Error( 'Network Error' ) ) );
			xhr.addEventListener( 'abort', () => reject( new Error( 'Abort' ) ) );

			xhr.send();
		} ).then( response => {
			output.innerText = `Response: ${ response }`;

			return response;
		} );
	}
</script>
</body>
</html>
